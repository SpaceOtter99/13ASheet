{% extends 'base.html' %}
{% block title %}{{ character.name }}{% endblock %}
{% block content %}
  <body>

    <div class="container">
      {% include 'sheet/info.html' %}
    </div>

    <div class="container">
      <div style="flex-grow: 14"> {% include 'sheet/stats.html' %} </div>
      <div style="flex-grow: 9"> {% include 'sheet/defence.html' %} </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const name = "{{ character.name }}";
      let timer, updated = {};

      function doSave(opts={}) {
        console.log("Saving with data", updated)
        fetch(`{{ url_for('update_character', id=request.view_args.id) }}`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          keepalive: opts.keepalive,
          body: JSON.stringify({ updates: updated })
        })
        .then(r => r.json())
        .then(j => {
          if (j.status==='ok') fetchLatestData();
          else console.warn('Save failed', j);
        })
        .catch(err => console.error(err));
      }

      function scheduleSave() {
        clearTimeout(timer);
        timer = setTimeout(doSave, 300);
      }

      function flushSave() {
        if (timer) {
          clearTimeout(timer);
          doSave({ keepalive:true });
          timer = null;
        }
      }

      function fetchLatestData() {
        fetch(`{{ url_for('get_character_data', id=request.view_args.id) }}`)
          .then(r => r.json())
          .then(data => {
            Object.entries(data).forEach(([section, payload]) => {
              Object.entries(payload).forEach(([key, value]) => {
                document
                  .querySelectorAll(`[data-section="${section}"][data-key="${key}"]`)
                  .forEach(el => {
                    if (el.tagName === 'INPUT') {
                      if (document.activeElement !== el) el.value = value;
                    } else {
                      el.textContent = value;
                    }
                  });
              });
            });
            updated = {};
          })
          .catch(err => console.error(err));
      }

      const inputs = document.querySelectorAll('[data-section][data-key]');
      console.log('Found', inputs.length, 'elements with data-section & data-key');
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          const sec = this.dataset.section;
          const key = this.dataset.key;
          updated[sec] = updated[sec] || {};
          updated[sec][key] = parseInt(this.value, 10) || this.value;
          scheduleSave();
        });
      });

      window.addEventListener('beforeunload', flushSave);
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') flushSave();
      });
    });
    </script>

  </body>
{% endblock %}